# 云原生多媒体分享平台 - 完整实施指南

## 📌 什么是云原生技术？

云原生 = 完全运行在云平台上的应用，不需要自己购买服务器，充分利用云的自动扩展、高可用等特性。

---

## 🎯 项目整体架构（推荐方案）

```
用户浏览器
    ↓
[Azure Static Web Apps] ← 前端HTML/CSS/JS
    ↓
[Azure Logic Apps / Functions] ← REST API
    ↓
├→ [Azure Blob Storage] ← 存储图片/视频文件
├→ [Azure Cosmos DB] ← NoSQL数据库存储元数据
└→ [Azure SQL Database] ← SQL数据库存储用户信息
    ↓
[Azure Application Insights] ← 监控和日志
```

---

## 🔧 第一步：准备工作

### 1. 注册Azure账号
- 访问：https://azure.microsoft.com/zh-cn/free/
- 学生账号可获得$100免费额度（需要学校邮箱）
- 或使用免费试用账号

### 2. 安装开发工具
```bash
# 必装工具：
- Visual Studio Code（代码编辑器）
- Azure CLI（命令行工具）
- Git（版本控制）
- Node.js（如果用前端）
```

### 3. Azure门户熟悉
- 登录：https://portal.azure.com
- 了解资源组（Resource Group）概念
- 创建一个资源组用于本项目，如：`multimedia-platform-rg`

---

## 📦 第二步：创建Azure资源（按顺序）

### 1️⃣ 创建存储账户（Storage Account）

**用途**：存储用户上传的图片、视频等文件

**操作步骤**：
```
Azure门户 → 创建资源 → 存储账户
- 名称：multimedia20XX（必须全局唯一）
- 性能：标准
- 复制：LRS（本地冗余存储）
- 访问层：热
```

**创建Blob容器**：
```
存储账户 → 容器 → 新建容器
- 名称：media-files
- 公共访问级别：Blob（允许匿名读取blob）
```

**获取连接字符串**：
```
存储账户 → 访问密钥 → 复制 Connection String
保存这个字符串，后面会用到！
```

---

### 2️⃣ 创建Cosmos DB（NoSQL数据库）

**用途**：存储媒体文件的元数据（文件名、上传时间、标签等）

**操作步骤**：
```
Azure门户 → 创建资源 → Azure Cosmos DB
- API：Core (SQL) 或 MongoDB
- 账户名：multimedia-cosmosdb-20XX
- 位置：选择离你近的区域
- 容量模式：无服务器（省钱）
```

**创建数据库和容器**：
```
Cosmos DB → 数据资源管理器 → 新建数据库
- 数据库ID：MediaDB
- 容器ID：MediaItems
- 分区键：/userId
```

**示例数据结构**：
```json
{
  "id": "unique-guid",
  "userId": "user123",
  "fileName": "sunset.jpg",
  "fileUrl": "https://xxx.blob.core.windows.net/media-files/sunset.jpg",
  "fileType": "image/jpeg",
  "uploadDate": "2025-11-03T10:30:00Z",
  "tags": ["sunset", "nature"],
  "fileSize": 2048576
}
```

---

### 3️⃣ 创建Azure SQL数据库（可选）

**用途**：存储用户信息、权限等结构化数据

**操作步骤**：
```
Azure门户 → 创建资源 → SQL数据库
- 数据库名：MediaUsersDB
- 服务器：新建服务器
- 计算+存储：基本（5 DTU）- 最便宜
```

**数据库表设计示例**：
```sql
-- 用户表
CREATE TABLE Users (
    UserId INT PRIMARY KEY IDENTITY,
    Username NVARCHAR(50) UNIQUE,
    Email NVARCHAR(100),
    CreatedDate DATETIME DEFAULT GETDATE()
);

-- 媒体文件表（可选，也可以只用Cosmos DB）
CREATE TABLE MediaFiles (
    FileId INT PRIMARY KEY IDENTITY,
    UserId INT FOREIGN KEY REFERENCES Users(UserId),
    FileName NVARCHAR(255),
    BlobUrl NVARCHAR(500),
    UploadDate DATETIME DEFAULT GETDATE()
);
```

---

### 4️⃣ 创建Logic Apps（REST API）

**用途**：实现CRUD操作的REST API端点

**操作步骤**：
```
Azure门户 → 创建资源 → Logic App
- 名称：multimedia-api-logic
- 类型：消耗
- 区域：与其他资源相同
```

**创建API示例 - 上传文件元数据**：

1. **触发器**：`When a HTTP request is received`
   ```json
   请求架构示例：
   {
     "userId": "string",
     "fileName": "string",
     "fileUrl": "string",
     "fileType": "string",
     "tags": ["string"]
   }
   ```

2. **操作1**：`Cosmos DB - Create or update document`
   - 连接到你的Cosmos DB
   - 数据库ID：MediaDB
   - 容器ID：MediaItems
   - 文档内容：使用HTTP请求的body

3. **操作2**：`Response`
   ```json
   {
     "status": "success",
     "message": "Media uploaded successfully",
     "id": "@{body('Create_or_update_document')?['id']}"
   }
   ```

**获取API URL**：保存后，复制HTTP POST URL，这就是你的REST API端点！

---

### 5️⃣ 创建Azure Functions（更灵活的选择）

**用途**：相比Logic Apps，Functions可以写代码实现更复杂逻辑

**操作步骤**：
```
Azure门户 → 创建资源 → 函数应用
- 名称：multimedia-functions-20XX
- 运行时堆栈：Node.js / Python / C#
- 版本：最新
- 操作系统：Windows
- 计划类型：消耗（无服务器）
```

**示例函数代码（Node.js）**：
```javascript
// HTTP触发器 - 上传文件元数据
module.exports = async function (context, req) {
    const { userId, fileName, fileUrl, fileType } = req.body;
    
    // 连接到Cosmos DB
    const { CosmosClient } = require("@azure/cosmos");
    const client = new CosmosClient(process.env.COSMOS_CONNECTION);
    const database = client.database("MediaDB");
    const container = database.container("MediaItems");
    
    // 创建文档
    const newItem = {
        id: generateGuid(),
        userId,
        fileName,
        fileUrl,
        fileType,
        uploadDate: new Date().toISOString()
    };
    
    await container.items.create(newItem);
    
    context.res = {
        status: 200,
        body: { status: "success", data: newItem }
    };
};
```

---

### 6️⃣ 创建Static Web App（前端托管）

**用途**：托管你的HTML/CSS/JavaScript前端页面

**操作步骤**：
```
Azure门户 → 创建资源 → 静态Web应用
- 名称：multimedia-frontend
- 部署来源：GitHub（或其他）
- 区域：选择离你近的
```

**前端示例代码**（index.html）：
```html
<!DOCTYPE html>
<html>
<head>
    <title>多媒体分享平台</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; }
        .upload-area { border: 2px dashed #ccc; padding: 50px; text-align: center; }
        .file-list { margin-top: 30px; }
        .file-item { padding: 10px; border: 1px solid #eee; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>📸 多媒体分享平台</h1>
    
    <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept="image/*,video/*">
        <button onclick="uploadFile()">上传文件</button>
    </div>
    
    <div class="file-list" id="fileList"></div>
    
    <script>
        const STORAGE_URL = 'https://YOUR_STORAGE.blob.core.windows.net/media-files/';
        const API_URL = 'https://YOUR_LOGIC_APP_URL';
        
        async function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('请选择文件');
            
            // 1. 上传到Blob Storage
            const blobUrl = await uploadToBlob(file);
            
            // 2. 保存元数据到API
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: 'user123',
                    fileName: file.name,
                    fileUrl: blobUrl,
                    fileType: file.type,
                    tags: ['demo']
                })
            });
            
            const result = await response.json();
            alert('上传成功！');
            loadFiles();
        }
        
        async function uploadToBlob(file) {
            // 使用Azure Storage SDK或SAS Token上传
            // 这里简化，实际需要后端生成SAS token
            return STORAGE_URL + file.name;
        }
        
        async function loadFiles() {
            // 调用GET API获取文件列表
            // 显示在页面上
        }
    </script>
</body>
</html>
```

---

### 7️⃣ 设置CI/CD（持续集成/部署）

**使用GitHub Actions**：

**步骤**：
1. 创建GitHub仓库
2. 推送代码到仓库
3. Azure Static Web App会自动生成GitHub Actions配置
4. 每次push代码，自动部署！

**示例workflow文件**（.github/workflows/azure-static-web-apps.yml）：
```yaml
name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Build And Deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: "api"
          output_location: ""
```

---

### 8️⃣ 添加监控（Application Insights）

**用途**：监控应用性能、错误、用户行为

**操作步骤**：
```
Azure门户 → 创建资源 → Application Insights
- 名称：multimedia-insights
- 资源组：选择项目资源组
```

**集成到Functions/Logic Apps**：
```
函数应用 → 设置 → Application Insights
→ 启用 → 选择刚创建的Insights
```

**查看监控数据**：
- 实时指标
- 失败请求
- 性能
- 用户流

---

## 🎨 第三步：完整的CRUD操作实现

### CREATE（创建/上传）
```
前端 → 选择文件 → 上传到Blob Storage
    → 调用Logic App/Function API
    → 存储元数据到Cosmos DB
    → 返回成功响应
```

### READ（读取/查询）
```
Logic App:
- HTTP GET触发器
- Cosmos DB: Query documents
  查询条件：SELECT * FROM c WHERE c.userId = @userId
- Response: 返回文件列表JSON
```

### UPDATE（更新）
```
Logic App:
- HTTP PUT触发器
- 接收参数：fileId, 新的tags等
- Cosmos DB: Update document
- Response: 返回更新后的文档
```

### DELETE（删除）
```
Logic App:
- HTTP DELETE触发器
- Cosmos DB: Delete document
- Blob Storage: 删除实际文件（可选）
- Response: 返回成功状态
```

---

## 📊 第四步：设计文档（作业1）需要的图表

### 1. 架构图（Architecture Diagram）
```
使用工具：Draw.io / Visio / Lucidchart

组件包括：
┌─────────────┐
│   用户/浏览器  │
└──────┬──────┘
       │
┌──────▼──────────────┐
│ Azure Static Web App│ (前端)
└──────┬──────────────┘
       │
┌──────▼──────────────┐
│ Azure Logic Apps/   │ (API层)
│ Azure Functions     │
└──┬────────┬────────┬┘
   │        │        │
   ▼        ▼        ▼
┌─────┐ ┌─────┐ ┌────────┐
│Blob │ │Cosmos│ │SQL DB  │
│Store│ │  DB  │ │        │
└─────┘ └─────┘ └────────┘
   │        │        │
   └────────┴────────┘
          │
    ┌─────▼─────┐
    │App Insights│
    └───────────┘
```

### 2. 数据库ERD图
```
使用工具：dbdiagram.io / MySQL Workbench

示例：
┌─────────────┐
│   Users     │
├─────────────┤
│ UserId (PK) │
│ Username    │
│ Email       │
│ CreatedDate │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────▼──────┐
│ MediaFiles  │
├─────────────┤
│ FileId (PK) │
│ UserId (FK) │
│ FileName    │
│ FileUrl     │
│ UploadDate  │
└─────────────┘
```

### 3. UML序列图（REST API）
```
客户端 -> API: POST /upload (文件信息)
API -> Blob: 存储文件
Blob -> API: 返回URL
API -> CosmosDB: 保存元数据
CosmosDB -> API: 返回文档ID
API -> 客户端: 返回成功+文件信息
```

### 4. 线框图（Wireframe）
```
使用工具：Figma / Balsamiq / 手绘

示例页面：
┌──────────────────────────────┐
│  📸 多媒体分享平台          │
├──────────────────────────────┤
│  [选择文件] [上传]           │
├──────────────────────────────┤
│ 我的文件：                   │
│ ┌────────┬────────┬────────┐ │
│ │ 🖼️图片1│ 🖼️图片2│ 🎥视频1│ │
│ │ [编辑] │ [编辑] │ [编辑] │ │
│ │ [删除] │ [删除] │ [删除] │ │
│ └────────┴────────┴────────┘ │
└──────────────────────────────┘
```

---

## 🎬 第五步：录制演示视频（作业2）

### 视频结构建议（5分钟）：

**0:00-0:30 开场介绍**
```
"大家好，我是XXX，这是我的云原生多媒体分享平台项目。
今天我将演示完整的CRUD功能和Azure资源部署。"
```

**0:30-2:00 演示应用功能**
```
1. 打开网站
2. 上传一张图片
3. 显示上传成功
4. 列表中显示新图片
5. 编辑图片标签
6. 删除一个文件
```

**2:00-3:30 展示Azure资源**
```
1. 打开Azure门户
2. 展示资源组中的所有资源
3. 打开Blob Storage，显示上传的文件
4. 打开Cosmos DB，显示数据库中的记录
5. 打开Logic Apps，显示API设计
6. 展示运行历史记录
```

**3:30-4:30 展示高级功能**
```
1. Application Insights监控数据
2. CI/CD - 展示GitHub Actions
3. 其他高级功能（如自动缩放设置等）
```

**4:30-5:00 总结**
```
"以上就是我的项目演示，使用了Azure的X、Y、Z等服务，
实现了完整的CRUD功能和云原生特性。谢谢观看！"
```

---

## 💡 关键技术要点

### 什么是云原生？
✅ **是**：使用云平台的托管服务（PaaS/SaaS）
❌ **不是**：在云上租虚拟机自己装软件（IaaS）

### 云原生的优势：
1. **无需管理服务器** - Azure帮你管理
2. **自动扩展** - 流量大时自动增加资源
3. **按需付费** - 用多少付多少
4. **高可用** - Azure保证99.9%可用性
5. **快速部署** - 几分钟创建资源

### 可扩展性设计：
1. **Blob Storage** - 自动扩展，无容量限制
2. **Cosmos DB** - 全球分布，自动分区
3. **Functions** - 自动根据请求数量扩展
4. **Logic Apps** - 无服务器，自动处理负载

---

## 📝 常见问题

**Q: 我没有Azure账号怎么办？**
A: 使用学校邮箱注册免费学生账号，有$100额度

**Q: 会不会很贵？**
A: 使用"消耗"/"无服务器"选项，开发测试阶段几乎免费

**Q: 我不会编程怎么办？**
A: Logic Apps是可视化的，不需要写代码！Functions可以选择

**Q: 必须用所有这些服务吗？**
A: 不是，但要体现"云原生"特性，建议至少用：
   - Blob Storage（文件存储）
   - Cosmos DB或SQL DB（数据库）
   - Logic Apps或Functions（API）
   - Static Web App（前端）
   - Application Insights（监控）

**Q: 视频演示要展示什么？**
A: 重点展示：
   1. 网站能正常工作（上传、查看、删除文件）
   2. Azure门户中的资源
   3. 数据确实存储在云上
   4. API能正常调用

---

## 🚀 快速开始检查清单

### 第一周（设计阶段）
- [ ] 注册Azure账号
- [ ] 熟悉Azure门户
- [ ] 画架构图
- [ ] 设计数据库模式
- [ ] 画线框图
- [ ] 设计REST API
- [ ] 完成PPT

### 第二周到第八周（实现阶段）
- [ ] 创建Azure资源组
- [ ] 创建Storage Account和Blob容器
- [ ] 创建Cosmos DB
- [ ] 创建Logic Apps实现CRUD
- [ ] 创建前端页面
- [ ] 部署Static Web App
- [ ] 集成前后端
- [ ] 测试完整流程
- [ ] 设置CI/CD
- [ ] 添加Application Insights
- [ ] 录制演示视频

---

## 📚 推荐学习资源

1. **Microsoft Learn**（免费官方教程）
   - Azure基础：https://docs.microsoft.com/learn/azure
   - Logic Apps：https://docs.microsoft.com/learn/paths/build-workflows-with-logic-apps/

2. **YouTube教程**
   - 搜索："Azure for Beginners"
   - 搜索："Azure Logic Apps Tutorial"

3. **示例项目**
   - Azure Samples GitHub: https://github.com/Azure-Samples

---

好运！有问题随时问我 🎉

