# Logic Apps 手把手操作指南 - 图形化界面操作

## 🎯 核心概念

**Logic Apps = 可视化编程 = 拖拽 + 点击 + 配置**

❌ **不需要**：写代码、创建文件、使用IDE、命令行部署  
✅ **只需要**：在Azure门户网页中点击、拖拽、填写参数

---

## 📖 完整操作流程（以上传Logic App为例）

### 第一步：登录Azure门户

1. 打开浏览器
2. 访问：https://portal.azure.com
3. 用你的Azure账号登录

---

### 第二步：创建Logic App

#### 1. 找到Logic Apps服务
```
方法1：在顶部搜索框输入 "Logic Apps" → 点击
方法2：左侧菜单 → 所有服务 → 搜索 "Logic Apps"
```

#### 2. 点击"创建"按钮
```
页面上方会有一个蓝色的 "+ 创建" 或 "+ Create" 按钮
```

#### 3. 填写基本信息
```
订阅：选择你的订阅（通常是免费试用或学生订阅）
资源组：
  - 如果已有：选择 multimedia-platform-rg
  - 如果没有：点击"新建"，输入 multimedia-platform-rg
  
Logic App名称：upload-media-logic
  （提示：名称只能包含字母、数字、-，必须全局唯一）

区域：East US （或选择离你近的区域）

计划类型：消耗（Consumption）
  ⚠️ 重要：必须选择"消耗"，这是无服务器版本，便宜！

启用日志分析：否（暂时不需要）
```

#### 4. 点击"查看 + 创建"
```
等待验证通过
```

#### 5. 点击"创建"
```
等待部署完成（通常1-2分钟）
```

#### 6. 部署完成后，点击"转到资源"
```
会跳转到Logic App的页面
```

---

### 第三步：设计工作流（重点！）

#### 1. 进入Logic Apps设计器

部署完成后，你会看到：
```
Logic Apps 设计器

选择一个模板开始：
[ ] 空白逻辑应用 ← 选这个！
[ ] 使用触发器时...
[ ] 循环模式
...
```

**点击"空白逻辑应用"**

---

#### 2. 添加HTTP触发器（第1个步骤）

设计器会显示：
```
┌────────────────────────────────┐
│ 搜索连接器和触发器              │
│ [搜索框]                       │
└────────────────────────────────┘
```

**操作步骤**：
```
1. 在搜索框输入: HTTP
2. 找到 "请求" (Request) 或 "HTTP" 分类
3. 点击触发器: "收到 HTTP 请求时" 
   (When a HTTP request is received)
```

**配置HTTP触发器**：

现在会出现一个配置面板：
```
┌─ 收到 HTTP 请求时 ──────────────┐
│                                │
│ 请求正文 JSON 架构              │
│ [使用示例有效负载生成架构]      │
│                                │
│ 方法                           │
│ [选择方法] ▼                   │
│                                │
└────────────────────────────────┘
```

**点击"使用示例有效负载生成架构"**，会弹出一个文本框：

**粘贴这个JSON**：
```json
{
    "fileName": "test.jpg",
    "fileType": "image/jpeg",
    "userId": "user123",
    "tags": ["demo", "test"],
    "fileContent": "base64encodedstring"
}
```

**点击"完成"**，架构会自动生成！

**配置方法**：
```
点击"方法"下拉框 → 选择 "POST"
```

**点击✓保存** （或者先不保存，继续添加步骤）

---

#### 3. 添加变量步骤（第2个步骤）

**点击设计器底部的 "+ 新步骤"** 按钮

**操作步骤**：
```
1. 在搜索框输入: 变量
2. 找到"变量"操作
3. 点击: "初始化变量"
```

**配置变量**：
```
┌─ 初始化变量 ────────────────────┐
│                                │
│ 名称 *                         │
│ [fileId____________]           │ ← 输入：fileId
│                                │
│ 类型 *                         │
│ [字符串▼]                      │ ← 选择：字符串
│                                │
│ 值                             │
│ [________________]             │ ← 点这里！
└────────────────────────────────┘
```

**重点：设置变量值为GUID**

在"值"输入框：
```
1. 点击输入框右侧的"⚡"图标（添加动态内容）
2. 会出现两个标签：
   - 动态内容
   - 表达式 ← 点这个！
3. 在表达式输入框输入: guid()
4. 点击"确定"
```

现在"值"框应该显示：`guid()`

---

#### 4. 再添加一个变量（blobName）

**点击 "+ 新步骤"**

重复上面步骤：
```
操作：初始化变量
名称：blobName
类型：字符串
值：点击输入框 → 点击⚡图标
```

**设置blobName的值**（需要组合）：

在"值"输入框：
```
1. 点击⚡图标 → 切换到"表达式"
2. 输入：concat(variables('fileId'), '-')
3. 点击确定
4. 然后再次点击输入框
5. 点击⚡ → "动态内容"标签
6. 找到并点击 "fileName"（从HTTP请求中来的）
```

最终应该显示类似：`@{concat(variables('fileId'), '-')}@{triggerBody()?['fileName']}`

---

#### 5. 添加Blob Storage步骤（第4个步骤）

**点击 "+ 新步骤"**

**搜索和选择**：
```
1. 搜索框输入: blob
2. 找到 "Azure Blob Storage"
3. 点击操作: "创建 Blob" (Create blob)
```

**首次使用需要创建连接**：

会弹出连接配置：
```
┌─ Azure Blob Storage ───────────┐
│                                │
│ 连接名称 *                     │
│ [BlobConnection_______]        │
│                                │
│ 身份验证类型                   │
│ [访问密钥▼]                    │
│                                │
│ Azure 存储账户名称或 Blob 终结点│
│ [____________________]         │
│                                │
│ Azure 存储账户访问密钥          │
│ [____________________]         │
│                                │
│        [创建] [取消]           │
└────────────────────────────────┘
```

**获取存储账户信息**：

**新开一个标签页** → Azure门户 → 你的存储账户 → 访问密钥：
```
1. 存储账户名称：multimedia20XX (复制)
2. 密钥：点击"显示"，复制 key1
```

**回到Logic Apps标签页**，填写：
```
连接名称：BlobConnection
身份验证类型：访问密钥
存储账户名称：multimedia20XX
访问密钥：粘贴刚才复制的密钥
```

**点击"创建"**

---

连接创建后，会显示Blob配置面板：
```
┌─ 创建 Blob ─────────────────────┐
│                                │
│ 存储账户名称 *                  │
│ [已选择: multimedia20XX]       │
│                                │
│ 文件夹路径 *                   │
│ [/media-files_____]            │ ← 输入：/media-files
│                                │
│ Blob 名称 *                    │
│ [____________________]  ⚡     │ ← 点击⚡，选择变量 blobName
│                                │
│ Blob 内容 *                    │
│ [____________________]  ⚡     │ ← 特殊处理，见下面
│                                │
└────────────────────────────────┘
```

**配置Blob内容**（Base64转二进制）：

在"Blob内容"输入框：
```
1. 点击⚡ → 切换到"表达式"
2. 输入: base64ToBinary(triggerBody()?['fileContent'])
3. 点击"确定"
```

**展开"显示高级选项"**（如果有）：
```
内容类型：点击⚡ → 动态内容 → 选择 fileType
```

---

#### 6. 添加Cosmos DB步骤（第6个步骤）

**点击 "+ 新步骤"**

**搜索和选择**：
```
搜索: cosmos
选择: Azure Cosmos DB
操作: "创建或更新文档 (V3)"
```

**创建Cosmos DB连接**：

首次使用会弹出：
```
┌─ Azure Cosmos DB ──────────────┐
│                                │
│ 连接名称                       │
│ [CosmosConnection_____]        │
│                                │
│ 身份验证类型                   │
│ [访问密钥▼]                    │
│                                │
│ 账户 ID                        │
│ [____________________]         │
│                                │
│ 访问密钥                       │
│ [____________________]         │
│                                │
│        [创建] [取消]           │
└────────────────────────────────┘
```

**获取Cosmos DB信息**：

新标签页 → Azure门户 → Cosmos DB → 密钥：
```
URI: https://multimedia-cosmosdb-20XX.documents.azure.com:443/
主密钥: (点击显示并复制)
```

**填写连接信息**：
```
连接名称: CosmosConnection
账户ID: multimedia-cosmosdb-20XX (从URI提取账户名)
访问密钥: 粘贴主密钥
```

**点击"创建"**

---

**配置Cosmos DB操作**：
```
┌─ 创建或更新文档 (V3) ───────────┐
│                                │
│ 数据库 ID *                    │
│ [MediaDB__________] ▼          │ ← 选择或输入 MediaDB
│                                │
│ 容器 ID *                      │
│ [MediaItems_______] ▼          │ ← 选择或输入 MediaItems
│                                │
│ 文档 *                         │
│ [____________________]         │ ← 点这里，见下面
│                                │
│ 分区键值 *                     │
│ [____________________]  ⚡     │ ← 点⚡，选择 userId
│                                │
└────────────────────────────────┘
```

**配置"文档"字段**（重要！）：

点击"文档"输入框，**切换到代码视图**（如果有切换按钮的话），或者直接输入：

```json
{
  "id": "",
  "userId": "",
  "fileName": "",
  "blobName": "",
  "fileUrl": "",
  "fileType": "",
  "tags": [],
  "uploadDate": "",
  "isDeleted": false
}
```

**现在填充动态内容**：

光标点击 `"id": ""` 的引号之间 → 点击⚡ → 选择 `fileId` 变量

重复这个过程：
- `"userId": ""` → 选择 `userId`（从HTTP请求）
- `"fileName": ""` → 选择 `fileName`
- `"blobName": ""` → 选择 `blobName` 变量
- `"fileUrl": ""` → 需要手动构建，点⚡ → 表达式 → 输入：
  ```
  concat('https://multimedia20XX.blob.core.windows.net/media-files/', variables('blobName'))
  ```
- `"fileType": ""` → 选择 `fileType`
- `"tags": []` → 在[]之间点击 → 选择 `tags`
- `"uploadDate": ""` → 点⚡ → 表达式 → 输入 `utcNow()`

**分区键值**：
```
点击⚡ → 动态内容 → 选择 userId
```

---

#### 7. 添加响应步骤（最后一步）

**点击 "+ 新步骤"**

**搜索和选择**：
```
搜索: 响应
选择: "响应" (Response)
```

**配置响应**：
```
┌─ 响应 ─────────────────────────┐
│                                │
│ 状态代码 *                     │
│ [200___________] ▼             │
│                                │
│ 正文                           │
│ [____________________]         │
│                                │
└────────────────────────────────┘
```

**填写响应正文**：

类似Cosmos DB文档，输入JSON结构：
```json
{
  "success": true,
  "message": "File uploaded successfully",
  "data": {
    "id": "",
    "fileName": "",
    "fileUrl": "",
    "uploadDate": ""
  }
}
```

用动态内容填充：
- `"id": ""` → 选择 `fileId` 变量
- `"fileName": ""` → 选择 `fileName`
- `"fileUrl": ""` → 同上面的fileUrl构建
- `"uploadDate": ""` → 表达式：`utcNow()`

---

#### 8. 保存Logic App

**点击顶部工具栏的"保存"按钮** 💾

等待保存成功！

---

#### 9. 获取API URL

**回到HTTP触发器步骤**（点击折叠的第一个步骤展开）

会看到：
```
┌─ 收到 HTTP 请求时 ─────────────┐
│                                │
│ HTTP POST URL                  │
│ [很长的URL...] 📋              │ ← 点击复制图标
│                                │
└────────────────────────────────┘
```

**复制这个URL**，保存到记事本！

格式类似：
```
https://prod-12.eastus.logic.azure.com:443/workflows/abc123.../triggers/manual/paths/invoke?api-version=2016-10-01&sp=xxx&sv=xxx&sig=xxx
```

**这就是你的上传API地址！** 🎉

---

## 🎯 操作流程总结

```
1. 创建Logic App资源
   ↓
2. 进入设计器，选择"空白逻辑应用"
   ↓
3. 拖拽/搜索添加步骤：
   - HTTP触发器
   - 初始化变量（fileId）
   - 初始化变量（blobName）
   - 创建Blob
   - 创建Cosmos DB文档
   - 响应
   ↓
4. 配置每个步骤的参数
   - 使用⚡图标添加动态内容
   - 使用表达式处理数据
   ↓
5. 保存
   ↓
6. 复制HTTP URL
```

---

## 🖱️ 重要操作技巧

### 1. 添加动态内容
```
任何输入框旁边都有⚡图标
点击后可以选择：
- 动态内容（前面步骤的输出）
- 表达式（函数，如guid(), utcNow()）
```

### 2. 常用表达式
```
guid()                               - 生成唯一ID
utcNow()                             - 当前UTC时间
concat('a', 'b')                     - 连接字符串
variables('变量名')                   - 获取变量值
triggerBody()?['字段名']              - 获取HTTP请求中的字段
base64ToBinary(xxx)                  - Base64转二进制
```

### 3. 查看运行历史
```
Logic App页面 → 概述 → 运行历史记录
可以看到每次运行的结果
点击某次运行可以看到每个步骤的详细信息
```

---

## 🔄 创建其他3个Logic Apps

**完全相同的流程**，只是步骤内容不同：

### GET Logic App (get-media-logic)
```
步骤：
1. HTTP触发器（GET方法）
2. 条件判断
3. Cosmos DB - 查询文档 / 读取文档
4. 响应
```

### UPDATE Logic App (update-media-logic)
```
步骤：
1. HTTP触发器（PUT方法）
2. Cosmos DB - 读取文档
3. Cosmos DB - 更新文档
4. 响应
```

### DELETE Logic App (delete-media-logic)
```
步骤：
1. HTTP触发器（DELETE方法）
2. Cosmos DB - 读取文档
3. Cosmos DB - 更新文档（设置isDeleted=true）
4. 响应
```

---

## 📱 实际界面长什么样？

### Logic Apps设计器界面
```
┌─────────────────────────────────────────┐
│ upload-media-logic | 🔄运行 💾保存      │ ← 顶部工具栏
├─────────────────────────────────────────┤
│                                         │
│  ┌─ 收到 HTTP 请求时 ───────────────┐  │
│  │ ▶ HTTP POST URL: https://...     │  │
│  └───────────────────────────────────┘  │
│              ↓                          │
│  ┌─ 初始化变量 ─────────────────────┐  │
│  │ 名称: fileId                      │  │
│  │ 值: guid()                        │  │
│  └───────────────────────────────────┘  │
│              ↓                          │
│  ┌─ 初始化变量 ─────────────────────┐  │
│  │ 名称: blobName                    │  │
│  └───────────────────────────────────┘  │
│              ↓                          │
│  ┌─ 创建 Blob ──────────────────────┐  │
│  │ 容器: media-files                 │  │
│  └───────────────────────────────────┘  │
│              ↓                          │
│  ┌─ 创建或更新文档 (V3) ────────────┐  │
│  │ 数据库: MediaDB                   │  │
│  └───────────────────────────────────┘  │
│              ↓                          │
│  ┌─ 响应 ───────────────────────────┐  │
│  │ 状态代码: 200                     │  │
│  └───────────────────────────────────┘  │
│                                         │
│         [+ 新步骤]                      │ ← 添加步骤按钮
└─────────────────────────────────────────┘
```

---

## ✅ 验证是否正确

### 测试Logic App

1. **使用内置测试**：
```
设计器顶部 → 点击"运行触发器" → "手动运行"
会弹出输入框，可以输入测试JSON
```

2. **使用Postman测试**：
```
复制HTTP URL
打开Postman
新建请求：
- 方法: POST
- URL: 粘贴Logic App URL
- Body → raw → JSON
- 输入测试数据
- 发送
```

3. **查看运行结果**：
```
Logic App页面 → 概述 → 运行历史记录
查看最新运行
✅ 成功（绿色）
❌ 失败（红色）- 点击查看错误详情
```

---

## 🆘 常见问题

### Q1: 找不到动态内容怎么办？
```
A: 确保前面的步骤已保存
   动态内容来自前面步骤的输出
   如果步骤未保存，可能看不到
```

### Q2: Cosmos DB连接失败
```
A: 检查：
   1. Cosmos DB是否创建成功
   2. 数据库名和容器名是否正确
   3. 访问密钥是否正确（从Azure门户重新复制）
```

### Q3: Blob上传失败
```
A: 检查：
   1. 容器名是否正确（media-files）
   2. 文件夹路径前面要加 / (/media-files)
   3. Base64转换表达式是否正确
```

### Q4: 可以在本地开发吗？
```
A: 不能！Logic Apps必须在Azure云端
   但可以在本地测试调用API
   Logic App本身的设计必须在Azure门户完成
```

---

## 🎬 视频演示中怎么展示Logic Apps？

### 演示步骤：
```
1. 打开Azure门户
2. 进入资源组
3. 点击 upload-media-logic
4. 点击"Logic App 设计器"
5. 展示整个工作流：
   "您可以看到，我设计了一个完整的上传流程：
    - 首先接收HTTP请求
    - 然后生成唯一文件ID
    - 接着上传文件到Blob Storage
    - 保存元数据到Cosmos DB
    - 最后返回成功响应"
6. 点击"概述"
7. 展示"运行历史记录"
8. 点击一个成功的运行
9. 展示每个步骤的执行结果
   "这里可以看到每个步骤都成功执行，
    数据流转正常"
```

---

## 📝 总结

**Logic Apps = 浏览器里的可视化编程**

- ✅ 全程在Azure门户网页操作
- ✅ 拖拽 + 点击 + 配置
- ✅ 不需要写代码文件
- ✅ 不需要IDE或命令行
- ✅ 保存后立即可用
- ✅ 自动获得REST API URL

---

**下一步**：
1. 先创建Storage Account和Cosmos DB
2. 然后创建第一个Logic App（上传）
3. 按照这个指南一步步配置
4. 测试成功后，再创建其他3个

有任何具体步骤不清楚的，随时问我！比如：
- "初始化变量那里具体怎么点？"
- "动态内容在哪里选？"
- "表达式怎么输入？"

我可以给你更详细的截图级别说明！🚀

